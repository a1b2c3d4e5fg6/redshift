<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kali Data Dashboard</title>
    <style>
        /* Keep all your existing styles */
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        /* ... keep all other styles ... */
        
        /* Add styles for auto-update indicator */
        .auto-update {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .update-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .updating {
            background-color: #28a745;
        }
        .paused {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Kali Data Dashboard</h1>
        <div>
            <span>Welcome, {{ username }}!</span>
            <a href="{{ url_for('logout') }}" class="btn btn-danger" style="margin-left: 15px;">Logout</a>
        </div>
    </div>

    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="auto-update">
            <span id="update-indicator" class="update-indicator updating"></span>
            <span id="update-status">Auto-update enabled (updates every 5 seconds)</span>
            <button id="toggle-update" class="btn" style="margin-left: 15px;">Pause Updates</button>
        </div>

        <div class="action-buttons">
            <button id="refresh-btn" class="btn">Refresh Now</button>
        </div>

        <h2>Network Traffic</h2>
        <div id="network-traffic-container">
            {% if network_traffic %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Source</th>
                            <th>Destination</th>
                            <th>Protocol</th>
                            <th>Service</th>
                            <th>Content</th>
                        </tr>
                    </thead>
                    <tbody id="network-traffic-body">
                        {% for traffic in network_traffic %}
                        <tr>
                            <td>{{ traffic.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            <td>{{ traffic.source }}</td>
                            <td>{{ traffic.dest }}</td>
                            <td>{{ traffic.protocol }}</td>
                            <td>{{ traffic.service }}</td>
                            <td class="content-cell">
                                {% if traffic.content %}
                                    {% if traffic.content|length > 100 %}
                                        {{ traffic.content[:100] }}...
                                        <span class="view-content-link" onclick="showPacketContent('{{ traffic.content | replace("'", "\\'") | replace('"', '\\"') }}')">View full content</span>
                                    {% else %}
                                        {{ traffic.content }}
                                    {% endif %}
                                {% else %}
                                    No content
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="no-data">
                    <h2>No network traffic data available</h2>
                    <p>Wait for data from your Kali machine.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Packet Content Modal -->
    <div id="packetModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>Packet Content Details</h3>
            <div class="packet-details" id="modal-content"></div>
        </div>
    </div>

    <script>
        let autoUpdateEnabled = true;
        let updateInterval;
        
        // Function to fetch latest data
        function fetchLatestData() {
            fetch('/api/network-traffic/latest')
                .then(response => response.json())
                .then(data => {
                    updateTable(data);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }
        
        // Function to update the table with new data
        function updateTable(data) {
            const tableBody = document.getElementById('network-traffic-body');
            
            if (data.length === 0) {
                // Show no data message
                document.getElementById('network-traffic-container').innerHTML = `
                    <div class="no-data">
                        <h2>No network traffic data available</h2>
                        <p>Wait for data from your Kali machine.</p>
                    </div>
                `;
                return;
            }
            
            // Create new table if it doesn't exist
            if (!tableBody) {
                document.getElementById('network-traffic-container').innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Source</th>
                                <th>Destination</th>
                                <th>Protocol</th>
                                <th>Service</th>
                                <th>Content</th>
                            </tr>
                        </thead>
                        <tbody id="network-traffic-body"></tbody>
                    </table>
                `;
            }
            
            // Clear existing table body
            const newTableBody = document.getElementById('network-traffic-body');
            newTableBody.innerHTML = '';
            
            // Add new rows
            data.forEach(traffic => {
                const row = document.createElement('tr');
                
                // Format timestamp
                const timestamp = new Date(traffic.timestamp);
                const formattedTimestamp = timestamp.toLocaleString();
                
                // Create content cell
                let contentCell = 'No content';
                if (traffic.content) {
                    if (traffic.content.length > 100) {
                        contentCell = `${traffic.content.substring(0, 100)}... <span class="view-content-link" onclick="showPacketContent('${traffic.content.replace(/'/g, "\\'").replace(/"/g, '\\"')}')">View full content</span>`;
                    } else {
                        contentCell = traffic.content;
                    }
                }
                
                row.innerHTML = `
                    <td>${formattedTimestamp}</td>
                    <td>${traffic.source}</td>
                    <td>${traffic.dest}</td>
                    <td>${traffic.protocol}</td>
                    <td>${traffic.service || ''}</td>
                    <td class="content-cell">${contentCell}</td>
                `;
                
                newTableBody.appendChild(row);
            });
        }
        
        // Function to toggle auto-update
        function toggleAutoUpdate() {
            autoUpdateEnabled = !autoUpdateEnabled;
            
            const indicator = document.getElementById('update-indicator');
            const status = document.getElementById('update-status');
            const button = document.getElementById('toggle-update');
            
            if (autoUpdateEnabled) {
                indicator.className = 'update-indicator updating';
                status.textContent = 'Auto-update enabled (updates every 5 seconds)';
                button.textContent = 'Pause Updates';
                startAutoUpdate();
            } else {
                indicator.className = 'update-indicator paused';
                status.textContent = 'Auto-update paused';
                button.textContent = 'Resume Updates';
                clearInterval(updateInterval);
            }
        }
        
        // Function to start auto-update
        function startAutoUpdate() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            updateInterval = setInterval(fetchLatestData, 5000); // Update every 5 seconds
        }
        
        // Modal functions
        function showPacketContent(content) {
            const modal = document.getElementById('packetModal');
            document.getElementById('modal-content').textContent = content;
            modal.style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('packetModal').style.display = 'none';
        }
        
        // Event listeners
        document.getElementById('toggle-update').addEventListener('click', toggleAutoUpdate);
        document.getElementById('refresh-btn').addEventListener('click', fetchLatestData);
        
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('packetModal');
            if (event.target == modal) {
                closeModal();
            }
        }
        
        // Start auto-update when page loads
        startAutoUpdate();
    </script>
</body>
</html>
