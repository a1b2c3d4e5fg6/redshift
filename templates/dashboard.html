<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Kali Data Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; margin:0; padding:0; }
    .header { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center; }
    .container { max-width:1400px; margin:20px auto; padding:0 20px; }
    .data-table { width:100%; border-collapse:collapse; margin:20px 0; background:white; border-radius:8px; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,0.05); }
    .data-table th,.data-table td{ padding:12px 15px; text-align:left; border-bottom:1px solid #eaeaea; vertical-align:top; }
    .data-table th{ background:#f8f9fa; font-weight:600; }
    .data-table tr:hover{ background-color: rgba(67,97,238,0.03); }
    .auto-update{ display:flex; align-items:center; margin-bottom:10px; }
    .update-indicator{ width:10px; height:10px; border-radius:50%; margin-right:8px; }
    .updating{ background-color:#28a745; }
    .paused{ background-color:#dc3545; }
    .btn{ padding:8px 16px; border:none; border-radius:4px; cursor:pointer; font-weight:600; }
    .btn-primary{ background:#4361ee; color:white; }
    .btn-danger{ background:#e63946; color:white; }
    .modal{ display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color: rgba(0,0,0,0.5); }
    .modal-content{ background:white; margin:5% auto; padding:25px; border-radius:10px; width:80%; max-width:900px; position:relative; }
    .close{ color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer; }
    .close:hover{ color:#000; }
    .packet-details{ background:#f8f9fa; padding:20px; border-radius:8px; margin-top:15px; font-family:monospace; white-space: pre-wrap; max-height:60vh; overflow:auto; }
    .view-content-link{ color:#0b63ff; text-decoration:underline; cursor:pointer; margin-left:8px; font-weight:600; }
    .open-window-link{ color:#0b63ff; text-decoration:underline; cursor:pointer; margin-left:10px; font-weight:600; font-size:0.95em; }
    .preview{ color:#333; }
    /* highlight for newest row */
    .new-traffic { background-color: #dff6e1 !important; transition: background-color 0.4s ease; }
    /* toast */
    .toast { position: fixed; right: 24px; top: 24px; background: rgba(0,0,0,0.85); color: #fff; padding: 10px 14px; border-radius: 8px; z-index: 2000; box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
    @media (max-width:800px) { .data-table th,.data-table td{ padding:8px 10px; font-size:13px; } }
  </style>
</head>
<body>
  <div class="header">
    <h1>Kali Data Dashboard</h1>
    <div>
      <span>Welcome, {{ username }}!</span>
      <a href="{{ url_for('logout') }}" class="btn btn-danger" style="margin-left:15px;">Logout</a>
    </div>
  </div>

  <div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="auto-update">
      <span id="update-indicator" class="update-indicator updating"></span>
      <span id="update-status">Auto-update enabled (updates every 5 seconds)</span>
      <button id="toggle-update" class="btn" style="margin-left:15px;">Pause Updates</button>
    </div>

    <div class="action-buttons">
      <button id="refresh-btn" class="btn btn-primary">Refresh Now</button>
    </div>

    <h2>Network Traffic</h2>
    <div id="network-traffic-container">
      {% if network_traffic %}
        <table class="data-table" id="network-table">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Source</th>
              <th>Destination</th>
              <th>Protocol</th>
              <!-- 5th column: Content preview + view link -->
              <th>Content (preview)</th>
              <th>Service</th>
            </tr>
          </thead>
          <tbody id="network-traffic-body">
            {% for traffic in network_traffic %}
            <tr data-id="{{ traffic.id }}">
              <td>
                {% if traffic.timestamp is string %}
                  {{ traffic.timestamp }}
                {% else %}
                  {{ traffic.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                {% endif %}
              </td>
              <td>{{ traffic.source }}</td>
              <td>{{ traffic.dest }}</td>
              <td>{{ traffic.protocol }}</td>

              <td class="content-cell">
                {% if traffic.content %}
                  {% set raw = traffic.content %}
                  {% if raw|length > 100 %}
                    <span class="preview">{{ raw[:100] }}...</span>
                    <span class="view-content-link" data-content='{{ raw|tojson|safe }}'>View full content</span>
                    <span class="open-window-link" data-content='{{ raw|tojson|safe }}' title="Open content in new window">Open in window</span>
                  {% else %}
                    <span class="preview">{{ raw }}</span>
                    <span class="open-window-link" data-content='{{ raw|tojson|safe }}' title="Open content in new window">Open in window</span>
                  {% endif %}
                {% else %}
                  No content
                {% endif %}
              </td>

              <td>{{ traffic.service }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="no-data">
          <h2>No network traffic data available</h2>
          <p>Wait for data from your Kali machine.</p>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Packet Content Modal -->
  <div id="packetModal" class="modal">
    <div class="modal-content">
      <span class="close" id="modal-close">&times;</span>
      <h3>Packet Content Details</h3>
      <div class="packet-details" id="modal-content"></div>
    </div>
  </div>

  <script>
    // Last-seen packet id (initially taken from server-side data if available)
    let lastSeenId = {{ (network_traffic[0].id if network_traffic else 'null')|tojson }};
    let highlightedRow = null;
    let autoUpdateEnabled = true;
    let updateInterval = null;

    // Toast helper
    function showToast(text, duration = 4000) {
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = text;
      document.body.appendChild(t);
      setTimeout(() => { t.style.opacity = '0'; setTimeout(()=>t.remove(), 400); }, duration);
    }

    // Safe parse of server JSON-encoded string (tojson used server side)
    function safeParseContent(raw) {
      if (raw === null || raw === undefined) return '';
      try {
        // raw is likely a JSON string: JSON.parse will return the original string with newlines preserved
        if (typeof raw === 'string') {
          return JSON.parse(raw);
        }
      } catch (e) {
        // fallback
      }
      return raw;
    }

    // Show content in modal (safe)
    function showModalWithContent(str) {
      const modal = document.getElementById('packetModal');
      const cnt = document.getElementById('modal-content');
      cnt.textContent = str;
      modal.style.display = 'block';
    }

    // Open content in new browser window (user-initiated click, so popup allowed)
    function openContentInWindow(str) {
      const w = window.open('', '_blank');
      if (!w) {
        // popup blocked; fallback to modal
        showModalWithContent(str);
        return;
      }
      // write a minimal page that preserves whitespace
      const esc = (s) => s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
      const contentHtml = `<pre style="white-space:pre-wrap;font-family:monospace;">${esc(str)}</pre>`;
      w.document.open();
      w.document.write(`<html><head><title>Packet Content</title></head><body>${contentHtml}</body></html>`);
      w.document.close();
    }

    // Event delegation for clicks on view/open links
    document.addEventListener('click', function(e) {
      const el = e.target;
      if (!el) return;

      if (el.classList && el.classList.contains('view-content-link')) {
        const raw = el.getAttribute('data-content');
        const content = safeParseContent(raw);
        showModalWithContent(content);
      }

      if (el.classList && el.classList.contains('open-window-link')) {
        const raw = el.getAttribute('data-content');
        const content = safeParseContent(raw);
        openContentInWindow(content);
      }
    });

    // Close modal handlers
    document.getElementById('modal-close').addEventListener('click', () => {
      document.getElementById('packetModal').style.display = 'none';
    });
    window.addEventListener('click', function(event) {
      const modal = document.getElementById('packetModal');
      if (event.target === modal) modal.style.display = 'none';
    });

    // Build or refresh table rows safely
    function updateTable(data) {
      const container = document.getElementById('network-traffic-container');
      if (!data || data.length === 0) {
        container.innerHTML = `<div class="no-data"><h2>No network traffic data available</h2><p>Wait for data from your Kali machine.</p></div>`;
        return;
      }

      // Ensure table is present
      if (!document.getElementById('network-traffic-body')) {
        container.innerHTML = `
          <table class="data-table" id="network-table">
            <thead>
              <tr>
                <th>Timestamp</th><th>Source</th><th>Destination</th><th>Protocol</th><th>Content (preview)</th><th>Service</th>
              </tr>
            </thead>
            <tbody id="network-traffic-body"></tbody>
          </table>
        `;
      }

      const tbody = document.getElementById('network-traffic-body');
      tbody.innerHTML = '';

      data.forEach((traffic, idx) => {
        const tr = document.createElement('tr');
        // store id for detection
        if (traffic.id !== undefined && traffic.id !== null) tr.setAttribute('data-id', traffic.id);

        // Timestamp
        const tdTime = document.createElement('td');
        tdTime.textContent = (typeof traffic.timestamp === 'string') ? traffic.timestamp : (traffic.timestamp ? new Date(traffic.timestamp).toLocaleString() : '');
        tr.appendChild(tdTime);

        // Source
        const tdSource = document.createElement('td'); tdSource.textContent = traffic.source || ''; tr.appendChild(tdSource);
        // Dest
        const tdDest = document.createElement('td'); tdDest.textContent = traffic.dest || ''; tr.appendChild(tdDest);
        // Protocol
        const tdProto = document.createElement('td'); tdProto.textContent = traffic.protocol || ''; tr.appendChild(tdProto);

        // Content (5th)
        const tdContent = document.createElement('td'); tdContent.className = 'content-cell';
        if (traffic.content) {
          const contentStr = (typeof traffic.content === 'string') ? traffic.content : JSON.stringify(traffic.content);
          if (contentStr.length > 100) {
            const preview = document.createElement('span'); preview.className = 'preview'; preview.textContent = contentStr.substring(0,100) + '...'; tdContent.appendChild(preview);
            const viewLink = document.createElement('span'); viewLink.className = 'view-content-link'; viewLink.setAttribute('data-content', JSON.stringify(contentStr)); viewLink.textContent = 'View full content'; tdContent.appendChild(viewLink);
            const openLink = document.createElement('span'); openLink.className = 'open-window-link'; openLink.setAttribute('data-content', JSON.stringify(contentStr)); openLink.textContent = 'Open in window'; tdContent.appendChild(openLink);
          } else {
            const preview = document.createElement('span'); preview.className = 'preview'; preview.textContent = contentStr; tdContent.appendChild(preview);
            const openLink = document.createElement('span'); openLink.className = 'open-window-link'; openLink.setAttribute('data-content', JSON.stringify(contentStr)); openLink.textContent = 'Open in window'; tdContent.appendChild(openLink);
          }
        } else {
          tdContent.textContent = 'No content';
        }
        tr.appendChild(tdContent);

        // Service
        const tdService = document.createElement('td'); tdService.textContent = traffic.service || ''; tr.appendChild(tdService);

        tbody.appendChild(tr);
      });

      // Detect new top item (first element)
      const first = data[0];
      const firstId = first && first.id ? Number(first.id) : null;
      if (lastSeenId === null) {
        // initial load: set lastSeenId but don't alert
        lastSeenId = firstId;
        // highlight the current top row as the newest (optional)
        highlightRowById(firstId);
      } else if (firstId !== null && firstId !== lastSeenId) {
        // new packet(s) arrived
        notifyNewPacket(firstId);
      }
    }

    // highlight a row by data-id and remove highlight from previous
    function highlightRowById(id) {
      try {
        if (highlightedRow) highlightedRow.classList.remove('new-traffic');
      } catch(e){}
      highlightedRow = document.querySelector(`tr[data-id="${id}"]`);
      if (highlightedRow) highlightedRow.classList.add('new-traffic');
    }

    // notify user + toast + highlight
    function notifyNewPacket(newId) {
      // Browser alert (explicit requirement)
      try { alert('New packet intercepted!'); } catch(e) {}

      // Small toast (non-blocking)
      showToast('New packet intercepted');

      // Update highlight
      highlightRowById(newId);

      // Update lastSeenId
      lastSeenId = Number(newId);
    }

    // Fetch latest data from server
    function fetchLatestData() {
      fetch('/api/network-traffic/latest')
        .then(resp => resp.json())
        .then(data => {
          // data expected as array of objects with .id, .timestamp, .source, .dest, .protocol, .service, .content
          updateTable(data);
        })
        .catch(err => { console.error('fetch error', err); });
    }

    // Auto-update controls
    function startAutoUpdate() { if (updateInterval) clearInterval(updateInterval); updateInterval = setInterval(fetchLatestData, 5000); }
    function stopAutoUpdate() { if (updateInterval) clearInterval(updateInterval); updateInterval = null; }

    document.getElementById('toggle-update').addEventListener('click', function() {
      autoUpdateEnabled = !autoUpdateEnabled;
      const indicator = document.getElementById('update-indicator');
      const status = document.getElementById('update-status');
      const btn = document.getElementById('toggle-update');
      if (autoUpdateEnabled) { indicator.className = 'update-indicator updating'; status.textContent = 'Auto-update enabled (updates every 5 seconds)'; btn.textContent = 'Pause Updates'; startAutoUpdate(); }
      else { indicator.className = 'update-indicator paused'; status.textContent = 'Auto-update paused'; btn.textContent = 'Resume Updates'; stopAutoUpdate(); }
    });

    document.getElementById('refresh-btn').addEventListener('click', fetchLatestData);

    // initialize: start auto-update and load data
    startAutoUpdate();
    // initial load
    fetchLatestData();
  </script>
</body>
</html>
