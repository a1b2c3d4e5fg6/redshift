from datetime import datetime

@app.route('/dashboard')
def dashboard():
    if 'user_id' not in session:
        return redirect(url_for('login'))
    
    # Get the latest network traffic data
    conn = get_db()
    network_traffic = conn.execute(
        'SELECT * FROM network_traffic ORDER BY timestamp DESC LIMIT 50'
    ).fetchall()
    conn.close()
    
    # Convert string timestamps to datetime objects
    formatted_traffic = []
    for traffic in network_traffic:
        traffic_dict = dict(traffic)
        # Convert timestamp if it's a string
        if isinstance(traffic_dict['timestamp'], str):
            try:
                traffic_dict['timestamp'] = datetime.strptime(
                    traffic_dict['timestamp'], '%Y-%m-%d %H:%M:%S'
                )
            except ValueError:
                # Handle different timestamp formats if needed
                pass
        formatted_traffic.append(traffic_dict)
    
    return render_template('dashboard.html', 
                         username=session['username'], 
                         network_traffic=formatted_traffic)
