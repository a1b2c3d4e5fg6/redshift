<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Kali Data Dashboard</title>
    <style>
        /* Your existing CSS styles (kept) */
        body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 0; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; display:flex; justify-content:space-between; align-items:center; }
        .container { max-width:1400px; margin:20px auto; padding:0 20px; }
        .data-table { width:100%; border-collapse:collapse; margin:20px 0; background:white; border-radius:8px; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,0.05); }
        .data-table th, .data-table td { padding:12px 15px; text-align:left; border-bottom:1px solid #eaeaea; vertical-align: top; }
        .data-table th { background-color:#f8f9fa; font-weight:600; }
        .data-table tr:hover { background-color: rgba(67,97,238,0.05); }
        .auto-update { display:flex; align-items:center; margin-bottom:10px; }
        .update-indicator { width:10px; height:10px; border-radius:50%; margin-right:8px; }
        .updating { background-color:#28a745; }
        .paused { background-color:#dc3545; }
        .btn { padding:8px 16px; border:none; border-radius:4px; cursor:pointer; font-weight:600; }
        .btn-primary { background:#4361ee; color:white; }
        .btn-danger { background:#e63946; color:white; }
        .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background:white; margin:5% auto; padding:25px; border-radius:10px; width:80%; max-width:800px; position:relative; }
        .close { color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer; }
        .close:hover { color:#000; }
        .packet-details { background:#f8f9fa; padding:20px; border-radius:8px; margin-top:15px; font-family:monospace; white-space: pre-wrap; max-height:60vh; overflow:auto; }
        .view-content-link { color:#0b63ff; text-decoration:underline; cursor:pointer; margin-left:8px; font-weight:600; }
        .preview { color:#333; }
        /* responsive small screens */
        @media (max-width: 800px) {
            .data-table th, .data-table td { padding:8px 10px; font-size:13px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Kali Data Dashboard</h1>
        <div>
            <span>Welcome, {{ username }}!</span>
            <a href="{{ url_for('logout') }}" class="btn btn-danger" style="margin-left:15px;">Logout</a>
        </div>
    </div>

    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="auto-update">
            <span id="update-indicator" class="update-indicator updating"></span>
            <span id="update-status">Auto-update enabled (updates every 5 seconds)</span>
            <button id="toggle-update" class="btn" style="margin-left:15px;">Pause Updates</button>
        </div>

        <div class="action-buttons">
            <button id="refresh-btn" class="btn btn-primary">Refresh Now</button>
        </div>

        <h2>Network Traffic</h2>
        <div id="network-traffic-container">
            {% if network_traffic %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Source</th>
                            <th>Destination</th>
                            <th>Protocol</th>
                            <!-- Fifth column is the packet content (preview + view link) -->
                            <th>Content (preview)</th>
                            <th>Service</th>
                        </tr>
                    </thead>
                    <tbody id="network-traffic-body">
                        {% for traffic in network_traffic %}
                        <tr>
                            <td>
                                {% if traffic.timestamp is string %}
                                    {{ traffic.timestamp }}
                                {% else %}
                                    {{ traffic.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                                {% endif %}
                            </td>
                            <td>{{ traffic.source }}</td>
                            <td>{{ traffic.dest }}</td>
                            <td>{{ traffic.protocol }}</td>

                            <!-- Content in column 5. Use data-content with safe JSON encoding so JS can parse it reliably. -->
                            <td class="content-cell">
                                {% if traffic.content %}
                                    {% set raw = traffic.content %}
                                    {% if raw|length > 100 %}
                                        <span class="preview">{{ raw[:100] }}...</span>
                                        <!-- data-content contains JSON-encoded string; JS will JSON.parse() it. -->
                                        <span class="view-content-link" data-content='{{ raw|tojson|safe }}'>View full content</span>
                                    {% else %}
                                        <span class="preview">{{ raw }}</span>
                                    {% endif %}
                                {% else %}
                                    No content
                                {% endif %}
                            </td>

                            <td>{{ traffic.service }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="no-data">
                    <h2>No network traffic data available</h2>
                    <p>Wait for data from your Kali machine.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Packet Content Modal -->
    <div id="packetModal" class="modal">
        <div class="modal-content">
            <span class="close" id="modal-close">&times;</span>
            <h3>Packet Content Details</h3>
            <div class="packet-details" id="modal-content"></div>
        </div>
    </div>

    <script>
        let autoUpdateEnabled = true;
        let updateInterval;

        // Safe parser: if raw is JSON-encoded (string literal), JSON.parse it; otherwise return raw.
        function safeParseContent(raw) {
            if (raw === null || raw === undefined) return '';
            try {
                // If raw looks like a JSON string literal, parse it.
                // Example raw: "\"Hello \\n world\"" or "\"{...}\""
                if (typeof raw === 'string' && raw.length && (raw[0] === '"' || raw[0] === '{' || raw[0] === '[')) {
                    return JSON.parse(raw);
                }
            } catch (e) {
                // parsing failed â€” fall through
            }
            return raw;
        }

        function showPacketContentFromString(contentString) {
            const modal = document.getElementById('packetModal');
            const modalContent = document.getElementById('modal-content');
            // always set textContent to avoid HTML injection
            modalContent.textContent = contentString;
            modal.style.display = 'block';
        }

        // Event delegation: open modal when a view-content-link is clicked
        document.addEventListener('click', function (e) {
            const el = e.target;
            if (el && el.classList && el.classList.contains('view-content-link')) {
                const raw = el.getAttribute('data-content');
                const content = safeParseContent(raw);
                showPacketContentFromString(content);
            }
        });

        // Function to fetch latest data
        function fetchLatestData() {
            fetch('/api/network-traffic/latest')
                .then(response => response.json())
                .then(data => {
                    updateTable(data);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }

        // Build table rows using DOM methods (avoid injection from building HTML strings)
        function updateTable(data) {
            const container = document.getElementById('network-traffic-container');

            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <h2>No network traffic data available</h2>
                        <p>Wait for data from your Kali machine.</p>
                    </div>
                `;
                return;
            }

            // Ensure table exists
            if (!document.getElementById('network-traffic-body')) {
                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Source</th>
                                <th>Destination</th>
                                <th>Protocol</th>
                                <th>Content (preview)</th>
                                <th>Service</th>
                            </tr>
                        </thead>
                        <tbody id="network-traffic-body"></tbody>
                    </table>
                `;
            }

            const tbody = document.getElementById('network-traffic-body');
            tbody.innerHTML = '';

            data.forEach(traffic => {
                const tr = document.createElement('tr');

                // Timestamp
                const tdTime = document.createElement('td');
                let ts = traffic.timestamp;
                if (typeof ts === 'string') {
                    tdTime.textContent = ts;
                } else {
                    try {
                        tdTime.textContent = new Date(ts).toLocaleString();
                    } catch (e) {
                        tdTime.textContent = String(ts);
                    }
                }
                tr.appendChild(tdTime);

                // Source
                const tdSource = document.createElement('td');
                tdSource.textContent = traffic.source || '';
                tr.appendChild(tdSource);

                // Destination
                const tdDest = document.createElement('td');
                tdDest.textContent = traffic.dest || '';
                tr.appendChild(tdDest);

                // Protocol
                const tdProto = document.createElement('td');
                tdProto.textContent = traffic.protocol || '';
                tr.appendChild(tdProto);

                // Content (5th column)
                const tdContent = document.createElement('td');
                tdContent.className = 'content-cell';
                if (traffic.content) {
                    const contentStr = (typeof traffic.content === 'string') ? traffic.content : JSON.stringify(traffic.content);
                    if (contentStr.length > 100) {
                        const preview = document.createElement('span');
                        preview.className = 'preview';
                        preview.textContent = contentStr.substring(0, 100) + '...';
                        tdContent.appendChild(preview);

                        const link = document.createElement('span');
                        link.className = 'view-content-link';
                        // store JSON-stringified content in data-content so JSON.parse() can reconstruct \n and quotes safely
                        link.setAttribute('data-content', JSON.stringify(contentStr));
                        link.textContent = 'View full content';
                        tdContent.appendChild(link);
                    } else {
                        const preview = document.createElement('span');
                        preview.className = 'preview';
                        preview.textContent = contentStr;
                        tdContent.appendChild(preview);
                    }
                } else {
                    tdContent.textContent = 'No content';
                }
                tr.appendChild(tdContent);

                // Service (6th column)
                const tdService = document.createElement('td');
                tdService.textContent = traffic.service || '';
                tr.appendChild(tdService);

                tbody.appendChild(tr);
            });
        }

        // Toggle auto-update
        function toggleAutoUpdate() {
            autoUpdateEnabled = !autoUpdateEnabled;
            const indicator = document.getElementById('update-indicator');
            const status = document.getElementById('update-status');
            const button = document.getElementById('toggle-update');

            if (autoUpdateEnabled) {
                indicator.className = 'update-indicator updating';
                status.textContent = 'Auto-update enabled (updates every 5 seconds)';
                button.textContent = 'Pause Updates';
                startAutoUpdate();
            } else {
                indicator.className = 'update-indicator paused';
                status.textContent = 'Auto-update paused';
                button.textContent = 'Resume Updates';
                clearInterval(updateInterval);
            }
        }

        function startAutoUpdate() {
            if (updateInterval) clearInterval(updateInterval);
            updateInterval = setInterval(fetchLatestData, 5000);
        }

        // Modal close
        function closeModal() {
            document.getElementById('packetModal').style.display = 'none';
        }

        document.getElementById('modal-close').addEventListener('click', closeModal);

        // close modal when clicking outside content
        window.addEventListener('click', function (event) {
            const modal = document.getElementById('packetModal');
            if (event.target === modal) closeModal();
        });

        // Buttons
        document.getElementById('toggle-update').addEventListener('click', toggleAutoUpdate);
        document.getElementById('refresh-btn').addEventListener('click', fetchLatestData);

        // Start
        startAutoUpdate();
        // initial load
        fetchLatestData();
    </script>
</body>
</html>
